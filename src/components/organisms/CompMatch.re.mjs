// Generated by ReScript, PLEASE EDIT WITH CARE

import * as React from "react";
import * as Rating from "../../lib/Rating.re.mjs";
import * as UiAction from "../atoms/UiAction.re.mjs";
import * as ReactIntl from "react-intl";
import * as Core__Array from "@rescript/core/src/Core__Array.re.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.re.mjs";
import * as Core from "@linaria/core";
import * as FramerMotion from "framer-motion";
import * as Caml_splice_call from "rescript/lib/es6/caml_splice_call.js";
import * as JsxRuntime from "react/jsx-runtime";

import { css, cx } from '@linaria/core'
;

import { t, plural } from '@lingui/macro'
;

function CompMatch$PlayerMini(props) {
  var player = props.player;
  return JsxRuntime.jsxs(JsxRuntime.Fragment, {
              children: [
                JsxRuntime.jsxs("span", {
                      children: [
                        player.name,
                        "(",
                        player.rating.mu.toFixed(2),
                        ")"
                      ],
                      className: "mr-2"
                    }),
                JsxRuntime.jsx("br", {})
              ]
            });
}

var PlayerMini = {
  make: CompMatch$PlayerMini
};

function CompMatch$MatchMini(props) {
  var match = props.match;
  var onSelect = props.onSelect;
  return JsxRuntime.jsx(UiAction.make, {
              onClick: (function () {
                  Core__Option.getOr(Core__Option.map(onSelect, (function (f) {
                              f(match);
                            })), undefined);
                }),
              className: "p-4 mb-2",
              children: JsxRuntime.jsxs("div", {
                    children: [
                      JsxRuntime.jsx("div", {
                            children: JsxRuntime.jsx("span", {
                                  children: match[0].map(function (p) {
                                        return JsxRuntime.jsx(CompMatch$PlayerMini, {
                                                    player: p
                                                  });
                                      })
                                }),
                            className: "col-span-3"
                          }),
                      JsxRuntime.jsx("div", {
                            children: " VS ",
                            className: "col-span-1 text-center text-2xl text-gray-800 font-bold"
                          }),
                      JsxRuntime.jsx("div", {
                            children: JsxRuntime.jsx("span", {
                                  children: match[1].map(function (p) {
                                        return JsxRuntime.jsx(CompMatch$PlayerMini, {
                                                    player: p
                                                  });
                                      })
                                }),
                            className: "col-span-3 justify-right text-right"
                          })
                    ],
                    className: "grid grid-cols-7 items-center place-content-center"
                  })
            });
}

var MatchMini = {
  make: CompMatch$MatchMini
};

function array_get_n_from(from, n, arr) {
  var n$1 = arr.length > 3 && arr.length < n ? arr.length : n;
  if (from >= (arr.length - (n$1 - 1 | 0) | 0)) {
    return ;
  }
  var arr$1 = arr.slice(from, from + n$1 | 0);
  if (n$1 === arr$1.length) {
    return arr$1;
  }
  
}

function array_split_by_n(arr, n) {
  var _from = 0;
  var _acc = [];
  while(true) {
    var acc = _acc;
    var from = _from;
    var next = array_get_n_from(from, n, arr);
    if (next === undefined) {
      return acc;
    }
    _acc = acc.concat([next]);
    _from = from + 1 | 0;
    continue ;
  };
}

function match_make_naive(players) {
  return array_split_by_n(players, 4).map(function (p) {
              return [
                      [
                        p[0],
                        p[3]
                      ],
                      [
                        p[1],
                        p[2]
                      ]
                    ];
            });
}

function team_to_players_set(team) {
  return new Set(team.map(function (p) {
                  return p.id;
                }));
}

function match_to_players_set(param) {
  return new Set(param[0].concat(param[1]).map(function (p) {
                  return p.id;
                }));
}

function matches_contains_match(matches, match) {
  return (function (__x) {
                return __x.map(match_to_players_set);
              })(matches).findIndex(function (m) {
              return m.intersection(match).size === 4;
            }) > -1;
}

function contains_match(matches, match) {
  return matches.map(function (param) {
                return match_to_players_set(param[0]);
              }).findIndex(function (m) {
              return m.intersection(match).size === 4;
            }) > -1;
}

function array_combos(arr) {
  return arr.flatMap(function (v, i) {
              return arr.slice(i + 1 | 0, arr.length).map(function (v2) {
                          return [
                                  v,
                                  v2
                                ];
                        });
            });
}

function combos(arr1, arr2) {
  return arr1.flatMap(function (d) {
              return arr2.map(function (v) {
                          return [
                                  d,
                                  v
                                ];
                        });
            });
}

function tuple2array(param) {
  return [
          param[0],
          param[1]
        ];
}

function match_quality(param) {
  return Rating.Rating.predictDraw([
              param[0].map(function (p) {
                    return p.rating;
                  }),
              param[1].map(function (p) {
                    return p.rating;
                  })
            ]);
}

function shuffle(arr) {
  return arr.map(function (value) {
                  return {
                          value: value,
                          sort: Math.random()
                        };
                }).toSorted(function (a, b) {
                return a.sort - b.sort;
              }).map(function (param) {
              return param.value;
            });
}

function find_all_match_combos(availablePlayers, priorityPlayers) {
  var teams = array_combos(availablePlayers).map(tuple2array);
  var result = Core__Array.reduce(teams, {
        seenTeams: [],
        matches: []
      }, (function (param, team) {
          var seenTeams = param.seenTeams;
          var players$p = availablePlayers.filter(function (p) {
                return !Rating.Team.contains_player(team, p);
              });
          var teams$p = array_combos(players$p).map(tuple2array);
          var teams$p$1 = teams$p.filter(function (t) {
                return seenTeams.findIndex(function (t$p) {
                            return Rating.TeamSet.is_equal_to(t$p, team_to_players_set(t));
                          }) === -1;
              });
          return {
                  seenTeams: seenTeams.concat([team_to_players_set(team)]),
                  matches: param.matches.concat(combos([team], teams$p$1))
                };
        }));
  var matches = result.matches.map(function (match) {
        var quality = match_quality(match);
        return [
                match,
                quality
              ];
      });
  if (priorityPlayers.length === 0) {
    return matches;
  } else {
    return matches.filter(function (param) {
                return Rating.Match.contains_any_players(param[0], priorityPlayers);
              });
  }
}

function strategy_by_competitive(players, consumedPlayers, priorityPlayers) {
  return Core__Array.reduce(array_split_by_n(Rating.Players.sortByRatingDesc(players), 8), [], (function (acc, playerSet) {
                var matches = find_all_match_combos(Rating.Players.filterOut(playerSet, consumedPlayers), priorityPlayers).toSorted(function (a, b) {
                      if (a[1] < b[1]) {
                        return 1;
                      } else {
                        return -1;
                      }
                    });
                return acc.concat(matches);
              }));
}

function strategy_by_competitive_plus(players, consumedPlayers, priorityPlayers) {
  return Core__Array.reduce(array_split_by_n(players.toSorted(function (a, b) {
                      var userA = a.rating.mu;
                      var userB = b.rating.mu;
                      if (userA < userB) {
                        return 1;
                      } else {
                        return -1;
                      }
                    }), 6), [], (function (acc, playerSet) {
                var matches = find_all_match_combos(Rating.Players.filterOut(playerSet, consumedPlayers), priorityPlayers).toSorted(function (a, b) {
                      if (a[1] < b[1]) {
                        return 1;
                      } else {
                        return -1;
                      }
                    });
                return acc.concat(matches);
              }));
}

function strategy_by_mixed(availablePlayers, priorityPlayers) {
  return find_all_match_combos(availablePlayers, priorityPlayers).toSorted(function (a, b) {
              if (a[1] < b[1]) {
                return 1;
              } else {
                return -1;
              }
            });
}

function strategy_by_round_robin(availablePlayers, priorityPlayers) {
  return find_all_match_combos(availablePlayers, priorityPlayers);
}

function strategy_by_random(availablePlayers, priorityPlayers) {
  var matches = find_all_match_combos(availablePlayers, priorityPlayers);
  return shuffle(matches);
}

function ts(prim0, prim1) {
  return Caml_splice_call.spliceApply(t, [
              prim0,
              prim1
            ]);
}

function CompMatch(props) {
  var onSelectMatch = props.onSelectMatch;
  var priorityPlayers = props.priorityPlayers;
  var consumedPlayers = props.consumedPlayers;
  var players = props.players;
  var match = React.useState(function () {
        return "CompetitivePlus";
      });
  var setStrategy = match[1];
  var strategy = match[0];
  var intl = ReactIntl.useIntl();
  var strats = [
    {
      name: t`Competitive Plus`,
      strategy: "CompetitivePlus",
      details: t`Matches are arranged by a maximum skill-spread of +- 1 players.`
    },
    {
      name: t`Competitive`,
      strategy: "Competitive",
      details: t`Matches are arranged by a maximum skill-spread of +- 2 players.`
    },
    {
      name: t`Mixed`,
      strategy: "Mixed",
      details: t`Matches are arranged by skill while mixing strong and weak players.`
    },
    {
      name: t`Random`,
      strategy: "Random",
      details: t`Totally random teams.`
    }
  ];
  var availablePlayers = Rating.Players.filterOut(players, consumedPlayers);
  var matches;
  switch (strategy) {
    case "CompetitivePlus" :
        matches = strategy_by_competitive_plus(players, consumedPlayers, priorityPlayers);
        break;
    case "Competitive" :
        matches = strategy_by_competitive(players, consumedPlayers, priorityPlayers);
        break;
    case "Mixed" :
        matches = strategy_by_mixed(availablePlayers, priorityPlayers);
        break;
    case "RoundRobin" :
        matches = find_all_match_combos(availablePlayers, priorityPlayers);
        break;
    case "Random" :
        matches = strategy_by_random(availablePlayers, priorityPlayers);
        break;
    
  }
  var matchesCount = matches.length;
  var matches$1 = matches.slice(0, 15);
  var maxQuality = Core__Array.reduce(matches$1, 0, (function (acc, param) {
          var quality = param[1];
          if (quality > acc) {
            return quality;
          } else {
            return acc;
          }
        }));
  var minQuality = Core__Array.reduce(matches$1, maxQuality, (function (acc, param) {
          var quality = param[1];
          if (quality < acc) {
            return quality;
          } else {
            return acc;
          }
        }));
  var tab = strats.find(function (tab) {
        return tab.strategy === strategy;
      });
  return JsxRuntime.jsxs(JsxRuntime.Fragment, {
              children: [
                JsxRuntime.jsxs("div", {
                      children: [
                        JsxRuntime.jsx("label", {
                              children: t`Select a tab`,
                              className: "sr-only",
                              htmlFor: "tabs"
                            }),
                        JsxRuntime.jsx("select", {
                              children: strats.map(function (tab) {
                                    return JsxRuntime.jsx("option", {
                                                children: tab.name,
                                                value: tab.name
                                              }, tab.name);
                                  }),
                              defaultValue: Core__Option.getOr(Core__Option.map(strats.find(function (tab) {
                                            return tab.strategy === strategy;
                                          }), (function (s) {
                                          return s.name;
                                        })), ""),
                              className: "block w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500",
                              id: "tabs",
                              name: "tabs",
                              onChange: (function (e) {
                                  setStrategy(function (param) {
                                        return Core__Option.getOr(Core__Option.map(strats.find(function (tab) {
                                                            return tab.name === e.target.value;
                                                          }), (function (s) {
                                                          return s.strategy;
                                                        })), "Competitive");
                                      });
                                })
                            })
                      ],
                      className: "sm:hidden"
                    }),
                JsxRuntime.jsx("div", {
                      children: JsxRuntime.jsx("nav", {
                            children: strats.map(function (tab) {
                                  return JsxRuntime.jsx(UiAction.make, {
                                              onClick: (function () {
                                                  setStrategy(function (param) {
                                                        return tab.strategy;
                                                      });
                                                }),
                                              className: Core.cx(strategy === tab.strategy ? "bg-indigo-100 text-indigo-700" : "text-gray-500 hover:text-gray-700", "rounded-md px-3 py-2 text-sm font-medium"),
                                              children: tab.name
                                            }, tab.name);
                                }),
                            "aria-label": "Tabs",
                            className: "flex space-x-4"
                          }),
                      className: "hidden sm:block"
                    }),
                JsxRuntime.jsxs("p", {
                      children: [
                        t`Analyzed ${intl.formatNumber(matchesCount)} matches.`,
                        " ",
                        Core__Option.getOr(Core__Option.map(tab, (function (tab) {
                                    return tab.details;
                                  })), null)
                      ],
                      className: "mt-2 text-base leading-7 text-gray-600"
                    }),
                matches$1.map(function (param, i) {
                      var quality = param[1];
                      var match = maxQuality - minQuality;
                      return JsxRuntime.jsxs(JsxRuntime.Fragment, {
                                  children: [
                                    JsxRuntime.jsx(CompMatch$MatchMini, {
                                          match: param[0],
                                          onSelect: onSelectMatch
                                        }, i.toString()),
                                    quality.toFixed(3),
                                    JsxRuntime.jsx("div", {
                                          children: JsxRuntime.jsx(FramerMotion.motion.div, {
                                                className: "h-2 rounded-full bg-red-400",
                                                animate: {
                                                  width: match !== 0 ? ((quality - minQuality) / (maxQuality - minQuality) * 100).toFixed(3) + "%" : "0%"
                                                },
                                                initial: {
                                                  width: "0%"
                                                }
                                              }),
                                          className: "overflow-hidden rounded-full bg-gray-200 mt-1"
                                        })
                                  ]
                                });
                    })
              ]
            });
}

var make = CompMatch;

export {
  PlayerMini ,
  MatchMini ,
  array_get_n_from ,
  array_split_by_n ,
  match_make_naive ,
  team_to_players_set ,
  match_to_players_set ,
  matches_contains_match ,
  contains_match ,
  array_combos ,
  combos ,
  tuple2array ,
  match_quality ,
  shuffle ,
  find_all_match_combos ,
  strategy_by_competitive ,
  strategy_by_competitive_plus ,
  strategy_by_mixed ,
  strategy_by_round_robin ,
  strategy_by_random ,
  ts ,
  make ,
}
/*  Not a pure module */
