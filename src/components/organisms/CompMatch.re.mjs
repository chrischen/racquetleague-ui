// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Util from "../shared/Util.re.mjs";
import * as React from "react";
import * as Rating from "../../lib/Rating.re.mjs";
import * as UiAction from "../atoms/UiAction.re.mjs";
import * as ReactIntl from "react-intl";
import * as Core__Array from "@rescript/core/src/Core__Array.re.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.re.mjs";
import * as Core from "@linaria/core";
import * as FramerMotion from "framer-motion";
import * as Caml_splice_call from "rescript/lib/es6/caml_splice_call.js";
import * as JsxRuntime from "react/jsx-runtime";

import { css, cx } from '@linaria/core'
;

import { t, plural } from '@lingui/macro'
;

function CompMatch$PlayerMini(props) {
  var player = props.player;
  return JsxRuntime.jsxs(JsxRuntime.Fragment, {
              children: [
                JsxRuntime.jsxs("span", {
                      children: [
                        player.name,
                        "(",
                        player.rating.mu.toFixed(2),
                        ")"
                      ],
                      className: "mr-2"
                    }),
                JsxRuntime.jsx("br", {})
              ]
            });
}

var PlayerMini = {
  make: CompMatch$PlayerMini
};

function CompMatch$MatchMini(props) {
  var match = props.match;
  var onSelect = props.onSelect;
  var highlight = props.highlight;
  return JsxRuntime.jsxs("div", {
              children: [
                JsxRuntime.jsxs("div", {
                      children: [
                        JsxRuntime.jsx("div", {
                              children: JsxRuntime.jsx("span", {
                                    children: match[0].map(function (p) {
                                          return JsxRuntime.jsx(CompMatch$PlayerMini, {
                                                      player: p
                                                    }, p.id);
                                        })
                                  }),
                              className: Core.cx("col-span-3 px-2 my-1 ml-1", Core__Option.getOr(Core__Option.map(highlight, (function (h) {
                                              switch (h) {
                                                case "Left" :
                                                case "Both" :
                                                    return "bg-yellow-100";
                                                case "Right" :
                                                case "Right2" :
                                                    return "";
                                                case "Left2" :
                                                case "Both2" :
                                                    return "bg-red-200";
                                                
                                              }
                                            })), ""))
                            }),
                        JsxRuntime.jsx("div", {
                              children: " VS ",
                              className: "col-span-1 text-center text-2xl text-gray-800 font-bold"
                            }),
                        JsxRuntime.jsx("div", {
                              children: JsxRuntime.jsx("span", {
                                    children: match[1].map(function (p) {
                                          return JsxRuntime.jsx(CompMatch$PlayerMini, {
                                                      player: p
                                                    }, p.id);
                                        })
                                  }),
                              className: Core.cx("col-span-3 justify-right text-right my-1 mr-1", Core__Option.getOr(Core__Option.map(highlight, (function (h) {
                                              switch (h) {
                                                case "Right" :
                                                case "Both" :
                                                    return "bg-yellow-100";
                                                case "Left" :
                                                case "Left2" :
                                                    return "";
                                                case "Right2" :
                                                case "Both2" :
                                                    return "bg-red-200";
                                                
                                              }
                                            })), ""))
                            })
                      ],
                      className: Core.cx("flex-1 grid grid-cols-7 items-center place-content-center", Core__Option.getOr(Core__Option.map(props.border, (function (h) {
                                      if (h === "Red") {
                                        return "border-red-200 border-4";
                                      } else {
                                        return "border-yellow-100 border-4";
                                      }
                                    })), ""))
                    }),
                JsxRuntime.jsx("div", {
                      children: JsxRuntime.jsx(UiAction.make, {
                            onClick: (function (param) {
                                Core__Option.getOr(Core__Option.map(onSelect, (function (f) {
                                            f(match);
                                          })), undefined);
                              }),
                            className: "ml-3 inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600",
                            children: t`Select`
                          }),
                      className: "self-center p-3"
                    })
              ],
              className: "flex pt-2 pl-2 pr-2"
            });
}

var MatchMini = {
  make: CompMatch$MatchMini
};

function array_get_n_from(from, n, arr) {
  var n$1 = arr.length > 3 && arr.length < n ? arr.length : n;
  if (from >= (arr.length - (n$1 - 1 | 0) | 0)) {
    return ;
  }
  var arr$1 = arr.slice(from, from + n$1 | 0);
  if (n$1 === arr$1.length) {
    return arr$1;
  }
  
}

function array_split_by_n(arr, n) {
  var _from = 0;
  var _acc = [];
  while(true) {
    var acc = _acc;
    var from = _from;
    var next = array_get_n_from(from, n, arr);
    if (next === undefined) {
      return acc;
    }
    _acc = acc.concat([next]);
    _from = from + 1 | 0;
    continue ;
  };
}

function match_make_naive(players) {
  return array_split_by_n(players, 4).map(function (p) {
              return [
                      [
                        p[0],
                        p[3]
                      ],
                      [
                        p[1],
                        p[2]
                      ]
                    ];
            });
}

function team_to_players_set(team) {
  return new Set(team.map(function (p) {
                  return p.id;
                }));
}

function match_to_players_set(param) {
  return new Set(param[0].concat(param[1]).map(function (p) {
                  return p.id;
                }));
}

function matches_contains_match(matches, match) {
  return (function (__x) {
                return __x.map(match_to_players_set);
              })(matches).findIndex(function (m) {
              return m.intersection(match).size === 4;
            }) > -1;
}

function contains_match(matches, match) {
  return matches.map(function (param) {
                return match_to_players_set(param[0]);
              }).findIndex(function (m) {
              return m.intersection(match).size === 4;
            }) > -1;
}

function array_combos(arr) {
  return arr.flatMap(function (v, i) {
              return arr.slice(i + 1 | 0, arr.length).map(function (v2) {
                          return [
                                  v,
                                  v2
                                ];
                        });
            });
}

function combos(arr1, arr2) {
  return arr1.flatMap(function (d) {
              return arr2.map(function (v) {
                          return [
                                  d,
                                  v
                                ];
                        });
            });
}

function tuple2array(param) {
  return [
          param[0],
          param[1]
        ];
}

function match_quality(param) {
  return Rating.Rating.predictDraw([
              param[0].map(function (p) {
                    return p.rating;
                  }),
              param[1].map(function (p) {
                    return p.rating;
                  })
            ]);
}

function shuffle(arr) {
  return arr.map(function (value) {
                  return {
                          value: value,
                          sort: Math.random()
                        };
                }).toSorted(function (a, b) {
                return a.sort - b.sort;
              }).map(function (param) {
              return param.value;
            });
}

function find_all_match_combos(availablePlayers, priorityPlayers, avoidAllPlayers, teamConstraints) {
  var teams = array_combos(availablePlayers).map(tuple2array);
  var teamConstraintsSet = new Set(Util.NonEmptyArray.toArray(teamConstraints).map(function (a) {
              return Array.from(a.values());
            }).flatMap(function (x) {
            return x;
          }));
  var implicitTeam = new Set(availablePlayers.filter(function (p) {
              return !teamConstraintsSet.has(p.id);
            }).map(function (p) {
            return p.id;
          }));
  var result = Core__Array.reduce(teams, {
        seenTeams: [],
        matches: []
      }, (function (param, team) {
          var seenTeams = param.seenTeams;
          var players$p = availablePlayers.filter(function (p) {
                return !Rating.Team.contains_player(team, p);
              });
          var teams$p = array_combos(players$p).map(tuple2array);
          var teams$p$1 = teams$p.filter(function (t) {
                return seenTeams.findIndex(function (t$p) {
                            return Rating.TeamSet.is_equal_to(t$p, team_to_players_set(t));
                          }) === -1;
              });
          return {
                  seenTeams: seenTeams.concat([team_to_players_set(team)]),
                  matches: param.matches.concat(combos([team], teams$p$1))
                };
        }));
  var matches = result.matches.map(function (match) {
        var quality = match_quality(match);
        return [
                match,
                quality
              ];
      });
  var results = priorityPlayers.length === 0 ? matches : matches.filter(function (param) {
          return Rating.Match.contains_any_players(param[0], priorityPlayers);
        });
  var results$1 = avoidAllPlayers.length < 2 ? results : results.filter(function (param) {
          return !Rating.Match.contains_all_players(param[0], avoidAllPlayers);
        });
  return Core__Option.getOr(Core__Option.map(teamConstraints, (function (teamConstraints) {
                    var teamConstraints$1 = teamConstraints.concat([implicitTeam]);
                    return results$1.filter(function (param) {
                                var match = param[0];
                                var team1 = Rating.Team.toSet(match[0]);
                                var team2 = Rating.Team.toSet(match[1]);
                                var constr1 = teamConstraints$1.findIndex(function (teamConstraint) {
                                      return Rating.TeamSet.containsAllOf(teamConstraint, team1);
                                    }) > -1;
                                var constr2 = teamConstraints$1.findIndex(function (teamConstraint) {
                                      return Rating.TeamSet.containsAllOf(teamConstraint, team2);
                                    }) > -1;
                                if (constr1) {
                                  return constr2;
                                } else {
                                  return false;
                                }
                              });
                  })), results$1);
}

function strategy_by_competitive(players, consumedPlayers, priorityPlayers, avoidAllPlayers, teams) {
  return Core__Array.reduce(array_split_by_n(Rating.Players.sortByRatingDesc(players), 8), [], (function (acc, playerSet) {
                var matches = find_all_match_combos(Rating.Players.filterOut(playerSet, consumedPlayers), priorityPlayers, avoidAllPlayers, teams).toSorted(function (a, b) {
                      if (a[1] < b[1]) {
                        return 1;
                      } else {
                        return -1;
                      }
                    });
                return acc.concat(matches);
              }));
}

function strategy_by_competitive_plus(players, consumedPlayers, priorityPlayers, avoidAllPlayers, teams) {
  return Core__Array.reduce(array_split_by_n(players.toSorted(function (a, b) {
                      var userA = a.rating.mu;
                      var userB = b.rating.mu;
                      if (userA < userB) {
                        return 1;
                      } else {
                        return -1;
                      }
                    }), 6), [], (function (acc, playerSet) {
                var matches = find_all_match_combos(Rating.Players.filterOut(playerSet, consumedPlayers), priorityPlayers, avoidAllPlayers, teams).toSorted(function (a, b) {
                      if (a[1] < b[1]) {
                        return 1;
                      } else {
                        return -1;
                      }
                    });
                return acc.concat(matches);
              }));
}

function strategy_by_mixed(availablePlayers, priorityPlayers, avoidAllPlayers, teams) {
  return find_all_match_combos(availablePlayers, priorityPlayers, avoidAllPlayers, teams).toSorted(function (a, b) {
              if (a[1] < b[1]) {
                return 1;
              } else {
                return -1;
              }
            });
}

function strategy_by_round_robin(availablePlayers, priorityPlayers, avoidAllPlayers, teams) {
  return find_all_match_combos(availablePlayers, priorityPlayers, avoidAllPlayers, teams);
}

function strategy_by_random(availablePlayers, priorityPlayers, avoidAllPlayers, teams) {
  var matches = find_all_match_combos(availablePlayers, priorityPlayers, avoidAllPlayers, teams);
  return shuffle(matches);
}

function strategy_by_dupr(availablePlayers, priorityPlayers, avoidAllPlayers) {
  var teams = Util.NonEmptyArray.fromArray(array_split_by_n(Rating.Players.sortByRatingDesc(availablePlayers), 3).map(function (__x) {
              return __x.map(function (p) {
                          return p.id;
                        });
            }).map(function (prim) {
            return new Set(prim);
          }));
  var matches = find_all_match_combos(availablePlayers, priorityPlayers, avoidAllPlayers, teams);
  return shuffle(matches);
}

function CompMatch$Settings(props) {
  return null;
}

var Settings = {
  make: CompMatch$Settings
};

function ts(prim0, prim1) {
  return Caml_splice_call.spliceApply(t, [
              prim0,
              prim1
            ]);
}

function CompMatch(props) {
  var onSelectMatch = props.onSelectMatch;
  var avoidAllPlayers = props.avoidAllPlayers;
  var priorityPlayers = props.priorityPlayers;
  var setDefaultStrategy = props.setDefaultStrategy;
  var defaultStrategy = props.defaultStrategy;
  var lastRoundSeenMatches = props.lastRoundSeenMatches;
  var lastRoundSeenTeams = props.lastRoundSeenTeams;
  var seenMatches = props.seenMatches;
  var seenTeams = props.seenTeams;
  var consumedPlayers = props.consumedPlayers;
  var players = props.players;
  var match = React.useState(function () {
        return defaultStrategy;
      });
  var setStrategy = match[1];
  var strategy = match[0];
  var intl = ReactIntl.useIntl();
  var strats = [
    {
      name: t`Competitive`,
      strategy: "CompetitivePlus",
      details: t`Matches are arranged by a maximum skill-spread of +- 1 players.`
    },
    {
      name: t`Mixed`,
      strategy: "Mixed",
      details: t`Matches are arranged by skill while mixing strong and weak players.`
    },
    {
      name: t`Random`,
      strategy: "Random",
      details: t`Totally random teams.`
    },
    {
      name: "DUPR",
      strategy: "DUPR",
      details: t`Optimized for DUPR. Teams created with similar skill level players.`
    }
  ];
  var availablePlayers = Rating.Players.filterOut(players, consumedPlayers);
  var teamConstraints = Util.NonEmptyArray.map(props.teams, Rating.Team.toSet);
  var matches;
  switch (strategy) {
    case "CompetitivePlus" :
        matches = strategy_by_competitive_plus(players, consumedPlayers, priorityPlayers, avoidAllPlayers, teamConstraints);
        break;
    case "Competitive" :
        matches = strategy_by_competitive(players, consumedPlayers, priorityPlayers, avoidAllPlayers, teamConstraints);
        break;
    case "Mixed" :
        matches = strategy_by_mixed(availablePlayers, priorityPlayers, avoidAllPlayers, teamConstraints);
        break;
    case "RoundRobin" :
        matches = strategy_by_round_robin(availablePlayers, priorityPlayers, avoidAllPlayers, teamConstraints);
        break;
    case "Random" :
        matches = strategy_by_random(availablePlayers, priorityPlayers, avoidAllPlayers, teamConstraints);
        break;
    case "DUPR" :
        matches = strategy_by_dupr(availablePlayers, priorityPlayers, avoidAllPlayers);
        break;
    
  }
  var matchesCount = matches.length;
  var matches$1 = matches.slice(0, 15);
  var maxQuality = Core__Array.reduce(matches$1, 0, (function (acc, param) {
          var quality = param[1];
          if (quality > acc) {
            return quality;
          } else {
            return acc;
          }
        }));
  var minQuality = Core__Array.reduce(matches$1, maxQuality, (function (acc, param) {
          var quality = param[1];
          if (quality < acc) {
            return quality;
          } else {
            return acc;
          }
        }));
  var tab = strats.find(function (tab) {
        return tab.strategy === strategy;
      });
  var updateStrategy = function (strategy) {
    setStrategy(function (param) {
          return strategy;
        });
    setDefaultStrategy(function (param) {
          return strategy;
        });
  };
  return JsxRuntime.jsxs(JsxRuntime.Fragment, {
              children: [
                JsxRuntime.jsxs("div", {
                      children: [
                        JsxRuntime.jsx("label", {
                              children: t`Select a tab`,
                              className: "sr-only",
                              htmlFor: "tabs"
                            }),
                        JsxRuntime.jsx("select", {
                              children: strats.map(function (tab) {
                                    return JsxRuntime.jsx("option", {
                                                children: tab.name,
                                                value: tab.name
                                              }, tab.name);
                                  }),
                              defaultValue: Core__Option.getOr(Core__Option.map(strats.find(function (tab) {
                                            return tab.strategy === strategy;
                                          }), (function (s) {
                                          return s.name;
                                        })), ""),
                              className: "block w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500",
                              id: "tabs",
                              name: "tabs",
                              onChange: (function (e) {
                                  updateStrategy(Core__Option.getOr(Core__Option.map(strats.find(function (tab) {
                                                    return tab.name === e.target.value;
                                                  }), (function (s) {
                                                  return s.strategy;
                                                })), "Competitive"));
                                })
                            })
                      ],
                      className: "sm:hidden"
                    }),
                JsxRuntime.jsx("div", {
                      children: JsxRuntime.jsx("nav", {
                            children: strats.map(function (tab) {
                                  return JsxRuntime.jsx(UiAction.make, {
                                              onClick: (function (param) {
                                                  updateStrategy(tab.strategy);
                                                }),
                                              className: Core.cx(strategy === tab.strategy ? "bg-indigo-100 text-indigo-700" : "text-gray-500 hover:text-gray-700", "rounded-md px-3 py-2 text-sm font-medium"),
                                              children: tab.name
                                            }, tab.name);
                                }),
                            "aria-label": "Tabs",
                            className: "flex space-x-4"
                          }),
                      className: "hidden sm:block"
                    }),
                JsxRuntime.jsxs("p", {
                      children: [
                        t`Analyzed ${intl.formatNumber(matchesCount)} matches.`,
                        " ",
                        Core__Option.getOr(Core__Option.map(tab, (function (tab) {
                                    return tab.details;
                                  })), null)
                      ],
                      className: "mt-2 text-base leading-7 text-gray-600"
                    }),
                JsxRuntime.jsxs("p", {
                      children: [
                        JsxRuntime.jsx("span", {
                              children: "...",
                              className: "px-2 py-1 bg-yellow-100"
                            }),
                        " = ",
                        t`This team has played before`,
                        JsxRuntime.jsx("span", {
                              children: "...",
                              className: "ml-2 px-2 py-1 bg-red-100"
                            }),
                        " = ",
                        t`Played last round`
                      ],
                      className: "mt-2 text-base leading-7 text-gray-600 mb-2"
                    }),
                matches$1.map(function (param, i) {
                      var match = param[0];
                      var team2 = match[1];
                      var team1 = match[0];
                      var match$1 = lastRoundSeenTeams.has(Rating.Team.toStableId(team1));
                      var match$2 = lastRoundSeenTeams.has(Rating.Team.toStableId(team2));
                      var highlight2 = match$1 ? (
                          match$2 ? "Both2" : "Left2"
                        ) : (
                          match$2 ? "Right2" : undefined
                        );
                      var match$3 = seenTeams.has(Rating.Team.toStableId(team1));
                      var match$4 = seenTeams.has(Rating.Team.toStableId(team2));
                      var highlight;
                      var exit = 0;
                      if (highlight2 !== undefined) {
                        var exit$1 = 0;
                        switch (highlight2) {
                          case "Left2" :
                              if (match$3) {
                                if (match$4) {
                                  exit = 1;
                                } else {
                                  highlight = "Left2";
                                }
                              } else {
                                exit$1 = 2;
                              }
                              break;
                          case "Right2" :
                              if (match$3) {
                                exit = 1;
                              } else if (match$4) {
                                highlight = "Right2";
                              } else {
                                exit$1 = 2;
                              }
                              break;
                          case "Both2" :
                              if (match$3) {
                                if (match$4) {
                                  highlight = "Both2";
                                } else {
                                  exit = 1;
                                }
                              } else {
                                exit$1 = 2;
                              }
                              break;
                          default:
                            exit$1 = 2;
                        }
                        if (exit$1 === 2) {
                          if (match$3 || match$4) {
                            exit = 1;
                          } else {
                            highlight = highlight2;
                          }
                        }
                        
                      } else if (match$3 || match$4) {
                        exit = 1;
                      } else {
                        highlight = undefined;
                      }
                      if (exit === 1) {
                        highlight = match$3 ? (
                            match$4 ? "Both" : "Left"
                          ) : "Right";
                      }
                      var match$5 = lastRoundSeenMatches.has(Rating.Match.toStableId(match));
                      var match$6 = seenMatches.has(Rating.Match.toStableId(match));
                      var border = match$5 ? "Red" : (
                          match$6 ? "Yellow" : undefined
                        );
                      var match$7 = maxQuality - minQuality;
                      return JsxRuntime.jsxs("div", {
                                  children: [
                                    JsxRuntime.jsx(CompMatch$MatchMini, {
                                          match: match,
                                          highlight: highlight,
                                          border: border,
                                          onSelect: onSelectMatch
                                        }),
                                    JsxRuntime.jsx("div", {
                                          children: JsxRuntime.jsx(FramerMotion.motion.div, {
                                                className: "h-2 rounded-full bg-red-400",
                                                animate: {
                                                  width: match$7 !== 0 ? ((param[1] - minQuality) / (maxQuality - minQuality) * 100).toFixed(3) + "%" : "0%"
                                                },
                                                initial: {
                                                  width: "0%"
                                                }
                                              }),
                                          className: "overflow-hidden rounded-full bg-gray-200 mt-1"
                                        })
                                  ],
                                  className: "border-zinc-600 rounded ring-1 mb-2"
                                }, i.toString());
                    })
              ]
            });
}

var make = CompMatch;

export {
  PlayerMini ,
  MatchMini ,
  array_get_n_from ,
  array_split_by_n ,
  match_make_naive ,
  team_to_players_set ,
  match_to_players_set ,
  matches_contains_match ,
  contains_match ,
  array_combos ,
  combos ,
  tuple2array ,
  match_quality ,
  shuffle ,
  find_all_match_combos ,
  strategy_by_competitive ,
  strategy_by_competitive_plus ,
  strategy_by_mixed ,
  strategy_by_round_robin ,
  strategy_by_random ,
  strategy_by_dupr ,
  Settings ,
  ts ,
  make ,
}
/*  Not a pure module */
