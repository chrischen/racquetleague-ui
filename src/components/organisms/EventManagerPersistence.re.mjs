// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Js_exn from "rescript/lib/es6/js_exn.js";
import * as Rating from "../../lib/Rating.re.mjs";
import * as Js_dict from "rescript/lib/es6/js_dict.js";
import * as Js_json from "rescript/lib/es6/js_json.js";
import * as Tinybase from "tinybase";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Array from "@rescript/core/src/Core__Array.re.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.re.mjs";
import * as Caml_js_exceptions from "rescript/lib/es6/caml_js_exceptions.js";
import * as Json_Decode$JsonCombinators from "@glennsl/rescript-json-combinators/src/Json_Decode.re.mjs";
import * as PersisterIndexedDb from "tinybase/persisters/persister-indexed-db";

var eventStore = Tinybase.createStore();

var eventPersister = PersisterIndexedDb.createIndexedDbPersister(eventStore, "pkuru-fairplay");

eventPersister.startAutoLoad(null).then(function (param) {
      return eventPersister.startAutoSave();
    });

function loadCurrentRound(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                            return Js_dict.get(row, "currentRound");
                          })), Js_json.decodeNumber), (function (prim) {
                    return prim | 0;
                  })), 0);
}

function saveCurrentRound(eventId, currentRound) {
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  existingRow["currentRound"] = currentRound;
  eventStore.setRow("eventState", eventId, existingRow);
}

function clearEventData(eventId) {
  eventStore.delRow("eventState", eventId);
  var matchesTable = eventStore.getTable("matches");
  var matchIdsToDelete = Core__Array.filterMap(Js_dict.entries(matchesTable), (function (param) {
          var mEventId = Core__Option.map(Js_dict.get(param[1], "eventId"), (function (v) {
                  return v;
                }));
          if (mEventId !== undefined && mEventId === eventId) {
            return param[0];
          }
          
        }));
  matchIdsToDelete.forEach(function (matchId) {
        eventStore.delRow("matches", matchId);
      });
}

function loadCourtCount(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                            return Js_dict.get(row, "courtCount");
                          })), Js_json.decodeNumber), (function (prim) {
                    return prim | 0;
                  })), 3);
}

function saveCourtCount(eventId, courtCount) {
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  existingRow["courtCount"] = courtCount;
  eventStore.setRow("eventState", eventId, existingRow);
}

function loadCheckedInPlayerIds(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                                return Js_dict.get(row, "checkedInPlayerIds");
                              })), Js_json.decodeString), (function (str) {
                        try {
                          return Js_json.decodeArray(JSON.parse(str));
                        }
                        catch (raw_e){
                          var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                          if (e.RE_EXN_ID === Js_exn.$$Error) {
                            console.log("[EventManagerPersistence] Failed to parse checkedInPlayerIds JSON for event:", eventId, e._1);
                          } else {
                            console.log("[EventManagerPersistence] Unknown error parsing checkedInPlayerIds JSON for event:", eventId);
                          }
                          return ;
                        }
                      })), (function (arr) {
                    return Core__Array.filterMap(arr, Js_json.decodeString);
                  })), []);
}

function saveCheckedInPlayerIds(eventId, playerIds) {
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  var playerIdsJson = Core__Option.getOr(JSON.stringify(playerIds), "[]");
  existingRow["checkedInPlayerIds"] = playerIdsJson;
  eventStore.setRow("eventState", eventId, existingRow);
}

function hydratePlayerWithRsvpData(player, rsvpMap) {
  var rsvp = Js_dict.get(rsvpMap, player.id);
  if (rsvp !== undefined) {
    return {
            data: Caml_option.some(Caml_option.valFromOption(rsvp)),
            id: player.id,
            intId: player.intId,
            name: player.name,
            rating: player.rating,
            ratingOrdinal: player.ratingOrdinal,
            paid: player.paid,
            gender: player.gender,
            count: player.count
          };
  } else {
    return {
            data: undefined,
            id: player.id,
            intId: player.intId,
            name: player.name,
            rating: player.rating,
            ratingOrdinal: player.ratingOrdinal,
            paid: player.paid,
            gender: player.gender,
            count: player.count
          };
  }
}

function loadMatchesFromDb(eventId, rsvpMap) {
  var matchesTable = eventStore.getTable("matches");
  return Core__Array.filterMap(Js_dict.entries(matchesTable), (function (param) {
                var matchRow = param[1];
                var matchId = param[0];
                var mEventId = Core__Option.map(Js_dict.get(matchRow, "eventId"), (function (v) {
                        return v;
                      }));
                if (mEventId === undefined) {
                  return ;
                }
                if (mEventId !== eventId) {
                  return ;
                }
                var team1Players = Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(matchRow, "team1Players"), Js_json.decodeString), (function (str) {
                                try {
                                  return Js_json.decodeArray(JSON.parse(str));
                                }
                                catch (raw_e){
                                  var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                                  if (e.RE_EXN_ID === Js_exn.$$Error) {
                                    console.log("[EventManagerPersistence] Failed to parse team1Players JSON for match:", matchId, e._1);
                                  } else {
                                    console.log("[EventManagerPersistence] Unknown error parsing team1Players JSON for match:", matchId);
                                  }
                                  return ;
                                }
                              })), (function (arr) {
                            return Core__Array.filterMap(arr, (function (playerJson) {
                                          var player = Json_Decode$JsonCombinators.decode(playerJson, Rating.Player.decodePlayer());
                                          if (player.TAG === "Ok") {
                                            return hydratePlayerWithRsvpData(player._0, rsvpMap);
                                          }
                                          console.log("[EventManagerPersistence] Failed to decode team1 player for match:", matchId, player._0);
                                        }));
                          })), []);
                var team2Players = Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(matchRow, "team2Players"), Js_json.decodeString), (function (str) {
                                try {
                                  return Js_json.decodeArray(JSON.parse(str));
                                }
                                catch (raw_e){
                                  var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                                  if (e.RE_EXN_ID === Js_exn.$$Error) {
                                    console.log("[EventManagerPersistence] Failed to parse team2Players JSON for match:", matchId, e._1);
                                  } else {
                                    console.log("[EventManagerPersistence] Unknown error parsing team2Players JSON for match:", matchId);
                                  }
                                  return ;
                                }
                              })), (function (arr) {
                            return Core__Array.filterMap(arr, (function (playerJson) {
                                          var player = Json_Decode$JsonCombinators.decode(playerJson, Rating.Player.decodePlayer());
                                          if (player.TAG === "Ok") {
                                            return hydratePlayerWithRsvpData(player._0, rsvpMap);
                                          }
                                          console.log("[EventManagerPersistence] Failed to decode team2 player for match:", matchId, player._0);
                                        }));
                          })), []);
                var roundIndex = Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Js_dict.get(matchRow, "roundIndex"), Js_json.decodeNumber), (function (prim) {
                            return prim | 0;
                          })), 0);
                var match = Core__Option.flatMap(Js_dict.get(matchRow, "hasScore"), Js_json.decodeBoolean);
                var score;
                if (match !== undefined && match) {
                  var team1Score = Core__Option.flatMap(Js_dict.get(matchRow, "team1Score"), Js_json.decodeNumber);
                  var team2Score = Core__Option.flatMap(Js_dict.get(matchRow, "team2Score"), Js_json.decodeNumber);
                  score = team1Score !== undefined && team2Score !== undefined ? [
                      team1Score,
                      team2Score
                    ] : undefined;
                } else {
                  score = undefined;
                }
                console.log("CreatedAt raw value:");
                var createdAt = Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Js_dict.get(matchRow, "createdAt"), Js_json.decodeNumber), (function (ts) {
                            return new Date(ts);
                          })), new Date());
                console.log(createdAt);
                return [
                        matchId,
                        team1Players,
                        team2Players,
                        roundIndex,
                        score,
                        createdAt
                      ];
              }));
}

function loadRatingAdjustmentHistory(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                                return Js_dict.get(row, "ratingAdjustmentHistory");
                              })), Js_json.decodeString), (function (str) {
                        try {
                          return Js_json.decodeArray(JSON.parse(str));
                        }
                        catch (raw_e){
                          var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                          if (e.RE_EXN_ID === Js_exn.$$Error) {
                            console.log("[EventManagerPersistence] Failed to parse ratingAdjustmentHistory JSON for event:", eventId, e._1);
                          } else {
                            console.log("[EventManagerPersistence] Unknown error parsing ratingAdjustmentHistory JSON for event:", eventId);
                          }
                          return ;
                        }
                      })), (function (arr) {
                    return Core__Array.filterMap(arr, Rating.RatingAdjustment.fromJson);
                  })), []);
}

function loadPlayerSeedAdjustments(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                                return Js_dict.get(row, "playerSeedAdjustments");
                              })), Js_json.decodeString), (function (str) {
                        try {
                          return Js_json.decodeObject(JSON.parse(str));
                        }
                        catch (raw_e){
                          var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                          if (e.RE_EXN_ID === Js_exn.$$Error) {
                            console.log("[EventManagerPersistence] Failed to parse playerSeedAdjustments JSON for event:", eventId, e._1);
                          } else {
                            console.log("[EventManagerPersistence] Unknown error parsing playerSeedAdjustments JSON for event:", eventId);
                          }
                          return ;
                        }
                      })), (function (dict) {
                    var result = {};
                    Js_dict.entries(dict).forEach(function (param) {
                          var adjustment = Js_json.decodeNumber(param[1]);
                          if (adjustment !== undefined) {
                            result[param[0]] = adjustment;
                            return ;
                          }
                          
                        });
                    return result;
                  })), {});
}

function savePlayerSeedAdjustments(eventId, adjustments) {
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  var adjustmentsJson = {};
  Js_dict.entries(adjustments).forEach(function (param) {
        adjustmentsJson[param[0]] = param[1];
      });
  var adjustmentsStr = Core__Option.getOr(JSON.stringify(adjustmentsJson), "{}");
  existingRow["playerSeedAdjustments"] = adjustmentsStr;
  eventStore.setRow("eventState", eventId, existingRow);
}

function saveRatingAdjustmentHistory(eventId, history) {
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  var historyJson = history.map(Rating.RatingAdjustment.toJson);
  var historyStr = Core__Option.getOr(JSON.stringify(historyJson), "[]");
  existingRow["ratingAdjustmentHistory"] = historyStr;
  eventStore.setRow("eventState", eventId, existingRow);
}

function loadTeams(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.flatMap(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                            return Js_dict.get(row, "teams");
                          })), Js_json.decodeString), (function (str) {
                    try {
                      return Core__Option.map(Js_json.decodeArray(JSON.parse(str)), (function (teamsJson) {
                                    return Core__Array.filterMap(teamsJson, (function (teamJson) {
                                                  return Core__Option.map(Js_json.decodeArray(teamJson), (function (playerJsons) {
                                                                return Core__Array.filterMap(playerJsons, Rating.Player.fromJson);
                                                              }));
                                                }));
                                  }));
                    }
                    catch (exn){
                      return ;
                    }
                  })), []);
}

function saveTeams(eventId, teams) {
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  var teamsJson = teams.map(function (team) {
        return team.map(Rating.Player.toJson);
      });
  var teamsStr = Core__Option.getOr(JSON.stringify(teamsJson), "[]");
  existingRow["teams"] = teamsStr;
  eventStore.setRow("eventState", eventId, existingRow);
}

function loadAntiTeams(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.flatMap(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                            return Js_dict.get(row, "antiTeams");
                          })), Js_json.decodeString), (function (str) {
                    try {
                      return Core__Option.map(Js_json.decodeArray(JSON.parse(str)), (function (teamsJson) {
                                    return Core__Array.filterMap(teamsJson, (function (teamJson) {
                                                  return Core__Option.map(Js_json.decodeArray(teamJson), (function (playerJsons) {
                                                                return Core__Array.filterMap(playerJsons, Rating.Player.fromJson);
                                                              }));
                                                }));
                                  }));
                    }
                    catch (exn){
                      return ;
                    }
                  })), []);
}

function saveAntiTeams(eventId, antiTeams) {
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  var antiTeamsJson = antiTeams.map(function (team) {
        return team.map(Rating.Player.toJson);
      });
  var antiTeamsStr = Core__Option.getOr(JSON.stringify(antiTeamsJson), "[]");
  existingRow["antiTeams"] = antiTeamsStr;
  eventStore.setRow("eventState", eventId, existingRow);
}

function loadPlayerOverrides(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.map(Core__Option.flatMap(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                                return Js_dict.get(row, "playerOverrides");
                              })), Js_json.decodeString), (function (str) {
                        try {
                          return Js_json.decodeObject(JSON.parse(str));
                        }
                        catch (raw_e){
                          var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                          if (e.RE_EXN_ID === Js_exn.$$Error) {
                            console.log("[EventManagerPersistence] Failed to parse playerOverrides JSON for event:", eventId, e._1);
                          } else {
                            console.log("[EventManagerPersistence] Unknown error parsing playerOverrides JSON for event:", eventId);
                          }
                          return ;
                        }
                      })), (function (dict) {
                    var result = {};
                    Js_dict.entries(dict).forEach(function (param) {
                          var playerId = param[0];
                          var overrideObj = Js_json.decodeObject(param[1]);
                          if (overrideObj === undefined) {
                            return ;
                          }
                          var override_name = Core__Option.flatMap(Js_dict.get(overrideObj, "name"), Js_json.decodeString);
                          var override_gender = Core__Option.map(Core__Option.flatMap(Js_dict.get(overrideObj, "gender"), Js_json.decodeNumber), (function (n) {
                                  return Rating.Gender.fromInt(n | 0);
                                }));
                          var override_paid = Core__Option.flatMap(Js_dict.get(overrideObj, "paid"), Js_json.decodeBoolean);
                          var override = {
                            playerId: playerId,
                            name: override_name,
                            gender: override_gender,
                            paid: override_paid
                          };
                          result[playerId] = override;
                        });
                    return result;
                  })), {});
}

function savePlayerOverride(eventId, playerId, name, gender, paid) {
  var existingOverrides = loadPlayerOverrides(eventId);
  var newOverride_name = name;
  var newOverride_gender = gender;
  var newOverride_paid = paid;
  var newOverride = {
    playerId: playerId,
    name: newOverride_name,
    gender: newOverride_gender,
    paid: newOverride_paid
  };
  var overrideObj = {};
  Core__Option.forEach(newOverride_name, (function (n) {
          overrideObj["name"] = n;
        }));
  Core__Option.forEach(newOverride_gender, (function (g) {
          overrideObj["gender"] = Rating.Gender.toInt(g);
        }));
  Core__Option.forEach(newOverride_paid, (function (p) {
          overrideObj["paid"] = p;
        }));
  existingOverrides[playerId] = newOverride;
  var overridesJson = {};
  Js_dict.entries(existingOverrides).forEach(function (param) {
        var override = param[1];
        var obj = {};
        Core__Option.forEach(override.name, (function (n) {
                obj["name"] = n;
              }));
        Core__Option.forEach(override.gender, (function (g) {
                obj["gender"] = Rating.Gender.toInt(g);
              }));
        Core__Option.forEach(override.paid, (function (p) {
                obj["paid"] = p;
              }));
        overridesJson[param[0]] = obj;
      });
  var overridesStr = Core__Option.getOr(JSON.stringify(overridesJson), "{}");
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  existingRow["playerOverrides"] = overridesStr;
  eventStore.setRow("eventState", eventId, existingRow);
}

function loadGuestPlayers(eventId) {
  var eventsTable = eventStore.getTable("eventState");
  return Core__Option.getOr(Core__Option.flatMap(Core__Option.flatMap(Core__Option.flatMap(Core__Option.flatMap(Js_dict.get(eventsTable, eventId), (function (row) {
                                return Js_dict.get(row, "guestPlayers");
                              })), Js_json.decodeString), (function (str) {
                        try {
                          return Js_json.decodeArray(JSON.parse(str));
                        }
                        catch (raw_e){
                          var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                          if (e.RE_EXN_ID === Js_exn.$$Error) {
                            console.log("[EventManagerPersistence] Failed to parse guestPlayers JSON for event:", eventId, e._1);
                          } else {
                            console.log("[EventManagerPersistence] Unknown error parsing guestPlayers JSON for event:", eventId);
                          }
                          return ;
                        }
                      })), (function (arr) {
                    if (arr.map(Rating.Player.fromJson).every(Core__Option.isSome)) {
                      return Core__Array.filterMap(arr, Rating.Player.fromJson);
                    }
                    
                  })), []);
}

function saveGuestPlayers(eventId, guestPlayers) {
  var guestPlayersJson = guestPlayers.map(Rating.Player.toJson);
  var guestPlayersStr = Core__Option.getOr(JSON.stringify(guestPlayersJson), "[]");
  var eventsTable = eventStore.getTable("eventState");
  var existingRow = Core__Option.getOr(Js_dict.get(eventsTable, eventId), {});
  existingRow["guestPlayers"] = guestPlayersStr;
  eventStore.setRow("eventState", eventId, existingRow);
}

function syncRoundsToDb(eventId, rounds) {
  var matchesTable = eventStore.getTable("matches");
  var matchIdsToDelete = Core__Array.filterMap(Js_dict.entries(matchesTable), (function (param) {
          var mEventId = Core__Option.map(Js_dict.get(param[1], "eventId"), (function (v) {
                  return v;
                }));
          if (mEventId !== undefined && mEventId === eventId) {
            return param[0];
          }
          
        }));
  matchIdsToDelete.forEach(function (matchId) {
        eventStore.delRow("matches", matchId);
      });
  rounds.forEach(function (roundMatches, roundIndex) {
        roundMatches.forEach(function (matchEntity) {
              var matchId = matchEntity.id;
              var match = matchEntity.match;
              var matchRowData = {};
              matchRowData["eventId"] = eventId;
              matchRowData["roundIndex"] = roundIndex;
              matchRowData["createdAt"] = matchEntity.createdAt.getTime();
              var team1Json = match[0].map(Rating.Player.toJson);
              var team2Json = match[1].map(Rating.Player.toJson);
              var team1PlayersJson = Core__Option.getOr(JSON.stringify(team1Json), "[]");
              var team2PlayersJson = Core__Option.getOr(JSON.stringify(team2Json), "[]");
              matchRowData["team1Players"] = team1PlayersJson;
              matchRowData["team2Players"] = team2PlayersJson;
              var match$1 = matchEntity.score;
              if (match$1 !== undefined) {
                matchRowData["hasScore"] = true;
                matchRowData["team1Score"] = match$1[0];
                matchRowData["team2Score"] = match$1[1];
              } else {
                matchRowData["hasScore"] = false;
              }
              eventStore.setRow("matches", matchId, matchRowData);
            });
      });
}

export {
  eventStore ,
  eventPersister ,
  loadCurrentRound ,
  saveCurrentRound ,
  clearEventData ,
  loadCourtCount ,
  saveCourtCount ,
  loadCheckedInPlayerIds ,
  saveCheckedInPlayerIds ,
  hydratePlayerWithRsvpData ,
  loadMatchesFromDb ,
  loadRatingAdjustmentHistory ,
  loadPlayerSeedAdjustments ,
  savePlayerSeedAdjustments ,
  saveRatingAdjustmentHistory ,
  loadTeams ,
  saveTeams ,
  loadAntiTeams ,
  saveAntiTeams ,
  loadPlayerOverrides ,
  savePlayerOverride ,
  loadGuestPlayers ,
  saveGuestPlayers ,
  syncRoundsToDb ,
}
/* eventStore Not a pure module */
