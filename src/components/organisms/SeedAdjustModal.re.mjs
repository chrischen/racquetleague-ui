// Generated by ReScript, PLEASE EDIT WITH CARE

import * as React from "react";
import * as DndKit from "../dndkit/DndKit.re.mjs";
import * as PlayerRow from "../molecules/PlayerRow.re.mjs";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Array from "@rescript/core/src/Core__Array.re.mjs";
import * as Core__Float from "@rescript/core/src/Core__Float.re.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.re.mjs";
import * as LucideReact from "lucide-react";
import * as Core from "@dnd-kit/core";
import * as Sortable from "@dnd-kit/sortable";
import * as JsxRuntime from "react/jsx-runtime";

import { t } from '@lingui/macro'
;

function SeedAdjustModal$SortableItemContent(props) {
  var dragHandleProps = props.dragHandleProps;
  var player = props.player;
  return JsxRuntime.jsx("div", {
              children: JsxRuntime.jsxs("div", {
                    children: [
                      JsxRuntime.jsx("div", {
                            children: JsxRuntime.jsx("span", {
                                  children: (props.index + 1 | 0).toString(),
                                  className: "text-lg font-bold text-slate-700"
                                }),
                            className: "flex-shrink-0 w-8 text-center"
                          }),
                      JsxRuntime.jsx("div", {
                            children: JsxRuntime.jsx(LucideReact.GripVertical, {
                                  className: "w-5 h-5 text-slate-400"
                                }),
                            ref: Caml_option.some(Core__Option.getOr(Core__Option.flatMap(dragHandleProps, (function (props) {
                                            return Caml_option.nullable_to_opt(props.ref);
                                          })), null)),
                            className: "flex-shrink-0 p-2 cursor-grab active:cursor-grabbing touch-none",
                            onClick: Core__Option.getOr(Core__Option.flatMap(dragHandleProps, (function (props) {
                                        return Caml_option.nullable_to_opt(props.onClick);
                                      })), null),
                            onPointerDown: Core__Option.getOr(Core__Option.flatMap(dragHandleProps, (function (props) {
                                        return Caml_option.nullable_to_opt(props.onPointerDown);
                                      })), null)
                          }),
                      JsxRuntime.jsx("div", {
                            children: JsxRuntime.jsx(PlayerRow.make, {
                                  player: player,
                                  isEditing: false,
                                  teamSide: "Left",
                                  skillLevel: props.skillLevel,
                                  getUserFragmentRefs: props.getUserFragmentRefs
                                }),
                            className: "flex-1 min-w-0"
                          }),
                      JsxRuntime.jsxs("div", {
                            children: [
                              JsxRuntime.jsx("div", {
                                    children: player.rating.mu.toFixed(1),
                                    className: "text-sm font-semibold text-slate-700"
                                  }),
                              JsxRuntime.jsx("div", {
                                    children: t`mu`,
                                    className: "text-xs text-slate-500"
                                  })
                            ],
                            className: "flex-shrink-0 text-right"
                          })
                    ],
                    className: "flex items-center gap-3 p-3"
                  }),
              className: "bg-white border-2 border-slate-200 rounded-lg hover:border-blue-400 transition-all"
            });
}

var SortableItemContent = {
  make: SeedAdjustModal$SortableItemContent
};

function SeedAdjustModal(props) {
  var getUserFragmentRefs = props.getUserFragmentRefs;
  var onClose = props.onClose;
  var onSave = props.onSave;
  var players = props.players;
  var match = React.useState(function () {
        return players.toSorted(function (a, b) {
                    return Core__Float.compare(b.rating.mu, a.rating.mu);
                  });
      });
  var setSortedPlayers = match[1];
  var sortedPlayers = match[0];
  var minRating = Core__Array.reduce(sortedPlayers.map(function (p) {
            return p.rating.mu;
          }), 100, (function (acc, next) {
          if (next < acc) {
            return next;
          } else {
            return acc;
          }
        }));
  var maxRating = Core__Array.reduce(sortedPlayers.map(function (p) {
            return p.rating.mu;
          }), 0, (function (acc, next) {
          if (next > acc) {
            return next;
          } else {
            return acc;
          }
        }));
  var handleSave = function () {
    var playerData = sortedPlayers.map(function (p) {
          return [
                  p.id,
                  p.rating.mu
                ];
        });
    onSave(playerData);
    onClose();
  };
  return JsxRuntime.jsx("div", {
              children: JsxRuntime.jsxs("div", {
                    children: [
                      JsxRuntime.jsx("div", {
                            children: JsxRuntime.jsxs("div", {
                                  children: [
                                    JsxRuntime.jsxs("div", {
                                          children: [
                                            JsxRuntime.jsx("h2", {
                                                  children: t`Adjust Player Seeds`,
                                                  className: "text-2xl font-bold text-slate-800"
                                                }),
                                            JsxRuntime.jsx("p", {
                                                  children: t`Drag players to reorder their initial seeding`,
                                                  className: "text-sm text-slate-600 mt-1"
                                                })
                                          ]
                                        }),
                                    JsxRuntime.jsx("button", {
                                          children: JsxRuntime.jsx(LucideReact.X, {
                                                className: "w-6 h-6 text-slate-600"
                                              }),
                                          className: "p-2 hover:bg-slate-100 rounded-lg transition-colors",
                                          onClick: (function (param) {
                                              onClose();
                                            })
                                        })
                                  ],
                                  className: "flex items-center justify-between"
                                }),
                            className: "p-6 border-b border-slate-200"
                          }),
                      JsxRuntime.jsx("div", {
                            children: JsxRuntime.jsx(Core.DndContext, {
                                  children: JsxRuntime.jsx(Sortable.SortableContext, {
                                        items: sortedPlayers.map(function (p) {
                                              return p.id;
                                            }),
                                        strategy: Caml_option.some(Sortable.verticalListSortingStrategy),
                                        children: JsxRuntime.jsx("div", {
                                              children: sortedPlayers.map(function (player, index) {
                                                    var skillLevel = maxRating === minRating ? 50 : (player.rating.mu - minRating) / (maxRating - minRating) * 100;
                                                    return JsxRuntime.jsx(DndKit.SortableItem.make, {
                                                                id: player.id,
                                                                handle: true,
                                                                children: JsxRuntime.jsx(SeedAdjustModal$SortableItemContent, {
                                                                      player: player,
                                                                      index: index,
                                                                      skillLevel: skillLevel,
                                                                      getUserFragmentRefs: getUserFragmentRefs
                                                                    })
                                                              }, player.id);
                                                  }),
                                              className: "space-y-2"
                                            })
                                      }),
                                  onDragEnd: (function ($$event) {
                                      var activeId = $$event.active.id;
                                      var overId = Core__Option.map($$event.over, (function (over) {
                                              return over.id;
                                            }));
                                      Core__Option.forEach(overId, (function (overId) {
                                              if (activeId !== overId) {
                                                return setSortedPlayers(function (currentPlayers) {
                                                            var oldIndex = currentPlayers.findIndex(function (p) {
                                                                  return p.id === activeId;
                                                                });
                                                            var newIndex = currentPlayers.findIndex(function (p) {
                                                                  return p.id === overId;
                                                                });
                                                            if (!(oldIndex !== -1 && newIndex !== -1)) {
                                                              return currentPlayers;
                                                            }
                                                            var mutablePlayers = currentPlayers.slice();
                                                            var item = mutablePlayers[oldIndex];
                                                            mutablePlayers.splice(oldIndex, 1);
                                                            mutablePlayers.splice(newIndex, 0, item);
                                                            var prevMu = newIndex > 0 ? Core__Option.map(mutablePlayers[newIndex - 1 | 0], (function (p) {
                                                                      return p.rating.mu;
                                                                    })) : undefined;
                                                            var nextMu = Core__Option.map(mutablePlayers[newIndex + 1 | 0], (function (p) {
                                                                    return p.rating.mu;
                                                                  }));
                                                            var newMu = prevMu !== undefined ? (
                                                                nextMu !== undefined ? (prevMu + nextMu) / 2.0 : prevMu - 0.01
                                                              ) : (
                                                                nextMu !== undefined ? nextMu + 0.01 : item.rating.mu
                                                              );
                                                            var updatedItem_data = item.data;
                                                            var updatedItem_id = item.id;
                                                            var updatedItem_intId = item.intId;
                                                            var updatedItem_name = item.name;
                                                            var updatedItem_rating = {
                                                              mu: newMu,
                                                              sigma: item.rating.sigma
                                                            };
                                                            var updatedItem_ratingOrdinal = item.ratingOrdinal;
                                                            var updatedItem_paid = item.paid;
                                                            var updatedItem_gender = item.gender;
                                                            var updatedItem_count = item.count;
                                                            var updatedItem = {
                                                              data: updatedItem_data,
                                                              id: updatedItem_id,
                                                              intId: updatedItem_intId,
                                                              name: updatedItem_name,
                                                              rating: updatedItem_rating,
                                                              ratingOrdinal: updatedItem_ratingOrdinal,
                                                              paid: updatedItem_paid,
                                                              gender: updatedItem_gender,
                                                              count: updatedItem_count
                                                            };
                                                            mutablePlayers.splice(newIndex, 1, updatedItem);
                                                            return mutablePlayers;
                                                          });
                                              }
                                              
                                            }));
                                    })
                                }),
                            className: "flex-1 overflow-y-auto p-6"
                          }),
                      JsxRuntime.jsxs("div", {
                            children: [
                              JsxRuntime.jsx("button", {
                                    children: t`Cancel`,
                                    className: "px-6 py-2.5 text-slate-700 hover:bg-slate-100 rounded-lg transition-colors font-medium",
                                    onClick: (function (param) {
                                        onClose();
                                      })
                                  }),
                              JsxRuntime.jsx("button", {
                                    children: t`Save Seed Adjustments`,
                                    className: "px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium shadow-sm",
                                    onClick: (function (param) {
                                        handleSave();
                                      })
                                  })
                            ],
                            className: "p-6 border-t border-slate-200 flex items-center justify-between gap-4"
                          })
                    ],
                    className: "bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col"
                  }),
              className: "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
            });
}

var make = SeedAdjustModal;

export {
  SortableItemContent ,
  make ,
}
/*  Not a pure module */
